name: Download and Deploy APIs to EC2

on:
  workflow_dispatch:
    inputs:
      apiFolder:
        description: 'API folder to download (or "all")'
        required: true
        default: 'all'
        type: choice
        options:
          - all
          - AHS.GC.Web
          - AHS.GC.authorizationportal
          - AHS.GC.ConfigAPI
          - AHS.GC.SmartComm
          - AHS.GC.Cloud
      cloudApi:
        description: 'Specific Cloud API to download (or "all")'
        required: true
        default: 'all'
        type: choice
        options:
          - all
          - account
          - activity
          - admin
          - assessments
          - master
          - member

jobs:
  download:
    runs-on: self-hosted
    env:
      RELEASE_REPO: Npraveenreddy/artifacts
      RELEASE_TAG: v8.17.2025.08_RC1
      GH_TOKEN: ${{ secrets.ARTIFACTS_PAT }}

    steps:
      - name: Create artifacts folder if not exists
        shell: powershell
        run: |
          $artifactsPath = "$env:GITHUB_WORKSPACE\artifacts"
          if (-not (Test-Path $artifactsPath)) {
            New-Item -Path $artifactsPath -ItemType Directory | Out-Null
          }

      - name: Download Artifacts
        shell: powershell
        run: |
          $apiFolder = "${{ github.event.inputs.apiFolder }}"
          $cloudApi = "${{ github.event.inputs.cloudApi }}"
          $artifactsPath = "$env:GITHUB_WORKSPACE\artifacts"

          $topLevelApis = @(
            "AHS.GC.Web",
            "AHS.GC.authorizationportal",
            "AHS.GC.ConfigAPI",
            "AHS.GC.SmartComm",
            "AHS.GC.Cloud"
          )
          $cloudSubApis = @(
            "account",
            "activity",
            "admin",
            "assessments",
            "master",
            "member"
          )

          function DownloadZip($name) {
            $zipPath = "$artifactsPath\$name.zip"
            echo $env:GH_TOKEN | gh auth login --with-token
            gh release download $env:RELEASE_TAG `
              --repo $env:RELEASE_REPO `
              --pattern "$name.zip" `
              --dir $artifactsPath `
              --clobber
            if (!(Test-Path $zipPath)) {
              Write-Error "Failed to download $name.zip"
              exit 1
            }
          }

          if ($apiFolder -eq "all") {
            foreach ($api in $topLevelApis) {
              if ($api -ne "AHS.GC.Cloud") { DownloadZip $api }
            }
          } elseif ($apiFolder -ne "AHS.GC.Cloud") {
            DownloadZip $apiFolder
          }

          if ($cloudApi -eq "all") {
            foreach ($sub in $cloudSubApis) { DownloadZip $sub }
          } elseif ($cloudSubApis -contains $cloudApi) {
            DownloadZip $cloudApi
          }

  deploy:
    runs-on: self-hosted
    needs: download
    env:
      EC2_HOST: ${{ secrets.EC2_HOST }}
      EC2_USER: ${{ secrets.EC2_USER }}
      SSH_KEY: ${{ secrets.EC2_SSH_KEY }}

    steps:
      - name: Deploy to EC2
        shell: powershell
        run: |
          $artifactsDir = "$env:GITHUB_WORKSPACE\artifacts"
          $sshKeyPath = "$env:GITHUB_WORKSPACE\ssh_key.pem"

          # Save SSH key
          Set-Content -Path $sshKeyPath -Value $env:SSH_KEY
          icacls $sshKeyPath /inheritance:r /grant:r "$($env:USERNAME):(R)"

          # Upload files
          scp -i $sshKeyPath "$artifactsDir\*.zip" "$($env:EC2_USER)@$($env:EC2_HOST):/tmp/"

          # Remote unzip and deploy
          $remoteScript = @'
          for zip in /tmp/*.zip; do
            name=$(basename "$zip" .zip)
            case "$name" in
              "AHS.GC.Web") target="/var/www/Portal" ;;
              "AHS.GC.authorizationportal") target="/var/www/AuthorizationPortal" ;;
              "AHS.GC.ConfigAPI") target="/var/www/CONFIGAPI" ;;
              "AHS.GC.SmartComm") target="/var/www/SmartCommAPI" ;;
              "account"|"activity"|"admin"|"assessments"|"master"|"member") target="/var/www/CloudAPI" ;;
              *) target="/var/www/$name" ;;
            esac
            mkdir -p "$target"
            unzip -o "$zip" -d "$target"
            rm -f "$zip"
          done
          '@
          ssh -i $sshKeyPath "$($env:EC2_USER)@$($env:EC2_HOST)" $remoteScript
