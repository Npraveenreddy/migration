name: Build All APIs

on:
  push:
    branches:
      - main
      - master
    paths:
      - 'AHS.GC.Web/**'
      - 'AHS.GC.authorizationportal/**'
      - 'AHS.GC.ConfigAPI/**'
      - 'AHS.GC.SmartComm/**'
      - 'AHS.GC.Cloud/**'

jobs:
  build:
    runs-on: windows-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '6.0.x'

      - name: Build all APIs (including Cloud subfolders)
        shell: pwsh
        run: |
          $apiFolders = @(
            "AHS.GC.Web",
            "AHS.GC.authorizationportal",
            "AHS.GC.ConfigAPI",
            "AHS.GC.SmartComm"
          )

          # Add every immediate subfolder of Cloud (account, activity, etc.)
          $cloudFolders = Get-ChildItem "./AHS.GC.Cloud" -Directory | ForEach-Object { $_.FullName }
          $apiFolders += $cloudFolders

          $failedBuilds = @()

          foreach ($folder in $apiFolders) {
            $name = Split-Path $folder -Leaf
            Write-Host "=== Building API: $name ==="

            # Look for a csproj anywhere in the folder (recursive)
            $proj = Get-ChildItem -Path $folder -Filter "*.csproj" -Recurse -ErrorAction SilentlyContinue | Select-Object -First 1
            if ($proj) {
              dotnet restore $proj.FullName
              if ($LASTEXITCODE -ne 0) {
                $failedBuilds += $name
                continue
              }
              dotnet build $proj.FullName --configuration Release --no-restore
              if ($LASTEXITCODE -ne 0) {
                $failedBuilds += $name
              }
            }
            else {
              Write-Host "‚ùå No .csproj found in $name"
              $failedBuilds += $name
            }
          }

          if ($failedBuilds.Count -gt 0) {
            Write-Error "Build failed for the following APIs: $($failedBuilds -join ', ')"
            exit 1
          }
