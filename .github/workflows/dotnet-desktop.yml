name: Build and Release APIs

on:
  workflow_dispatch:
    inputs:
      apiFolder:
        description: 'API folder to build (AHS.GC.Web, AHS.GC.Cloud, or all)'
        required: true
        default: 'AHS.GC.Web'
        type: choice
        options:
          - AHS.GC.Web
          - AHS.GC.Cloud
          - all
      cloudApi:
        description: 'Specific Cloud API to build (account, user, all, or leave blank)'
        required: false
        default: ''
        type: choice
        options:
          - ''
          - account
          - user
          - all

jobs:
  build-and-release:
    runs-on: windows-latest

    env:
      RELEASE_TAG: v1.0.0  # You can make this dynamic if needed

    steps:
      - name: ‚¨áÔ∏è Checkout code
        uses: actions/checkout@v3

      - name: üîß Setup GitHub CLI
        uses: actions/setup-gh@v3

      - name: üîê Authenticate GitHub CLI
        run: gh auth setup-git
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: üõ†Ô∏è Build and Upload APIs
        shell: pwsh
        run: |
          $apiFolder = "${{ github.event.inputs.apiFolder }}"
          $cloudApi = "${{ github.event.inputs.cloudApi }}"

          $workspace = "$env:GITHUB_WORKSPACE"
          $releaseTag = $env:RELEASE_TAG
          $cloudSubApis = @("account", "user", "notification")  # Add more as needed

          function BuildAndUpload($path, $name) {
              Write-Host "üìÅ Building: $path ($name)"
              $zipPath = "$workspace\$name.zip"
              Compress-Archive -Path "$workspace\$path\*" -DestinationPath $zipPath -Force
              Write-Host "üì¶ Created ZIP: $zipPath"
              gh release upload $releaseTag $zipPath --clobber
              Write-Host "üì§ Uploaded $name.zip to release $releaseTag"
          }

          if ($apiFolder -eq "all") {
              BuildAndUpload "AHS.GC.Web" "AHS.GC.Web"
              foreach ($sub in $cloudSubApis) {
                  BuildAndUpload "AHS.GC.Cloud\$sub" "$sub"
              }
          }
          else {
              if ($apiFolder -eq "AHS.GC.Web") {
                  BuildAndUpload "AHS.GC.Web" "AHS.GC.Web"
              }

              if ($cloudApi -ne "") {
                  if ($cloudApi -eq "all") {
                      foreach ($sub in $cloudSubApis) {
                          BuildAndUpload "AHS.GC.Cloud\$sub" "$sub"
                      }
                  }
                  else {
                      BuildAndUpload "AHS.GC.Cloud\$cloudApi" "$cloudApi"
                  }
              }
          }
