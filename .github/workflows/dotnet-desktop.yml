name: Build and Release APIs

on:
  workflow_dispatch:
    inputs:
      apiFolder:
        description: 'Top-level API folder to build (or "all")'
        required: true
        default: 'AHS.GC.Web'
        type: choice
        options:
          - AHS.GC.Web
          - AHS.GC.authorizationportal
          - AHS.GC.ConfigAPI
          - AHS.GC.SmartComm
          - AHS.GC.Cloud
          - all
      cloudApi:
        description: 'Specific Cloud API to build (or "all")'
        required: false
        default: ''
        type: choice
        options:
          - ''
          - all
          - account
          - activity
          - admin
          - assessments
          - master
          - member

jobs:
  build-and-release:
    runs-on: windows-latest

    env:
      RELEASE_TAG: v1.0.0

    steps:
      - name: ‚¨áÔ∏è Checkout code
        uses: actions/checkout@v3

      - name: üîß Setup GitHub CLI
        uses: actions/setup-gh@v3

      - name: üîê Authenticate GitHub CLI
        run: gh auth setup-git
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: üõ†Ô∏è Build and Upload APIs
        shell: pwsh
        run: |
          $apiFolder = "${{ github.event.inputs.apiFolder }}"
          $cloudApi = "${{ github.event.inputs.cloudApi }}"
          $workspace = "$env:GITHUB_WORKSPACE"
          $releaseTag = $env:RELEASE_TAG

          # Detect all top-level folders
          $topLevelApis = Get-ChildItem $workspace -Directory | Select-Object -ExpandProperty Name

          # Detect sub-APIs in AHS.GC.Cloud
          $cloudSubApis = Get-ChildItem "$workspace\AHS.GC.Cloud" -Directory | Select-Object -ExpandProperty Name

          function BuildAndUpload($path, $name) {
              Write-Host "üìÅ Building: $path ($name)"
              $zipPath = "$workspace\$name.zip"
              Compress-Archive -Path "$workspace\$path\*" -DestinationPath $zipPath -Force
              Write-Host "üì¶ Created ZIP: $zipPath"
              gh release upload $releaseTag $zipPath --clobber
              Write-Host "üì§ Uploaded $name.zip to release $releaseTag"
          }

          if ($apiFolder -eq "all") {
              foreach ($folder in $topLevelApis) {
                  if ($folder -eq "AHS.GC.Cloud") {
                      foreach ($sub in $cloudSubApis) {
                          BuildAndUpload "AHS.GC.Cloud\$sub" "$sub"
                      }
                  }
                  else {
                      BuildAndUpload $folder $folder
                  }
              }
          }
          else {
              if ($apiFolder -eq "AHS.GC.Cloud") {
                  if ($cloudApi -eq "all") {
                      foreach ($sub in $cloudSubApis) {
                          BuildAndUpload "AHS.GC.Cloud\$sub" "$sub"
                      }
                  }
                  elseif ($cloudApi -ne "") {
                      BuildAndUpload "AHS.GC.Cloud\$cloudApi" "$cloudApi"
                  }
              }
              else {
                  BuildAndUpload $apiFolder $apiFolder
              }
          }
