name: Build APIs Manually

on:
  workflow_dispatch:
    inputs:
      apiFolder:
        description: 'API folder to build (or "all" to build everything)'
        required: true
        default: 'all'
        type: choice
        options:
          - all
          - AHS.GC.Web
          - AHS.GC.authorizationportal
          - AHS.GC.ConfigAPI
          - AHS.GC.SmartComm
          - AHS.GC.Cloud
      cloudApi:
        description: 'Specific Cloud API to build (or "all")'
        required: true
        default: 'all'
        type: choice
        options:
          - all
          - account
          - activity
          - admin
          - assessments
          - master
          - member

jobs:
  build:
    runs-on: windows-latest
    env:
      RELEASE_REPO: Npraveenreddy/artifacts
      RELEASE_TAG: v8.17.2025.08_RC1
      DOTNET_ROOT: C:\Program Files\dotnet
      GITHUB_TOKEN: ${{ secrets.ARTIFACTS_PAT }}  # ‚úÖ Use your custom PAT here

    steps:
    - name: üì¶ Checkout code
      uses: actions/checkout@v4

    - name: üõ†Ô∏è Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '6.0.x'

    - name: üîß Build Selected APIs and Upload Artifacts
      shell: pwsh
      run: |
        $apiFolder = "${{ github.event.inputs.apiFolder }}"
        $cloudApi = "${{ github.event.inputs.cloudApi }}"
        $workspace = $env:GITHUB_WORKSPACE

        $topLevelApis = @(
          "AHS.GC.Web",
          "AHS.GC.authorizationportal",
          "AHS.GC.ConfigAPI",
          "AHS.GC.SmartComm",
          "AHS.GC.Cloud"
        )

        $cloudSubApis = @(
          "account",
          "activity",
          "admin",
          "assessments",
          "master",
          "member"
        )

        function BuildAndUpload($path, $name) {
          Write-Host "üî® Building $name"
          $proj = Get-ChildItem $path -Filter "*.csproj" -Recurse -ErrorAction SilentlyContinue | Select-Object -First 1
          if (-not $proj) {
            Write-Error "‚ùå No .csproj found in $name"
            exit 1
          }

          dotnet restore $proj.FullName
          if ($LASTEXITCODE -ne 0) {
            Write-Error "‚ùå Restore failed for $name"
            exit 1
          }

          dotnet build $proj.FullName --configuration Release --no-restore
          if ($LASTEXITCODE -ne 0) {
            Write-Error "‚ùå Build failed for $name"
            exit 1
          }

          $outputPath = Join-Path $path "bin\Release\net6.0"
          $zipPath = "$workspace\$name.zip"

          Write-Host "üì¶ Zipping contents of: $outputPath"
          Compress-Archive -Path "$outputPath\*" -DestinationPath $zipPath

          if (Test-Path $zipPath) {
            gh auth login --with-token < $env:GITHUB_TOKEN  # ‚úÖ Explicitly authenticate
            gh release upload $env:RELEASE_TAG $zipPath --repo $env:RELEASE_REPO --clobber
            Write-Host "‚úÖ Uploaded $name.zip to release $env:RELEASE_TAG"
          } else {
            Write-Error "‚ùå ZIP not found for $name"
            exit 1
          }
        }

        if ($apiFolder -eq "all") {
          foreach ($api in $topLevelApis) {
            if ($api -eq "AHS.GC.Cloud") {
              foreach ($sub in $cloudSubApis) {
                BuildAndUpload "$api\$sub" "$sub"
              }
            } else {
              BuildAndUpload $api $api
            }
          }
        } elseif ($apiFolder -eq "AHS.GC.Cloud") {
          if ($cloudApi -eq "all") {
            foreach ($sub in $cloudSubApis) {
              BuildAndUpload "$apiFolder\$sub" "$sub"
            }
          } else {
            BuildAndUpload "$apiFolder\$cloudApi" "$cloudApi"
          }
        } else {
          BuildAndUpload $apiFolder $apiFolder
        }
