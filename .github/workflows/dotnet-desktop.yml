name: Release AHS APIs

on:
  workflow_dispatch:
    inputs:
      target:
        description: 'Which APIs to release? (comma-separated or "all")'
        required: true
        default: 'all'

jobs:
  release:
    runs-on: windows-latest
    env:
      DOTNET_ROOT: C:\Program Files\dotnet
      RELEASE_REPO: Npraveenreddy/artifacts
      RELEASE_TAG: v8.17.2025.08_RC1

    steps:
    - name: üì¶ Checkout code
      uses: actions/checkout@v3

    - name: üõ†Ô∏è Setup .NET
      uses: actions/setup-dotnet@v3
      with:
        dotnet-version: '8.0.x'

    - name: üîß Build and Upload Selected APIs
      shell: pwsh
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        $allApis = @("AHS.GC.Web", "AHS.GC.Auth", "AHS.GC.Admin")  # üëà Add all available APIs here
        $input = "${{ github.event.inputs.target }}"

        if ($input -eq "all") {
          $selectedApis = $allApis
        } else {
          $selectedApis = $input.Split(",") | ForEach-Object { $_.Trim() }
        }

        foreach ($api in $selectedApis) {
          if (-not ($allApis -contains $api)) {
            Write-Error "‚ùå Unknown API: $api"
            exit 1
          }

          Write-Host "üî® Building $api"
          dotnet build "$api/$api.csproj" -c Release

          $zipName = "$api.zip"
          $zipPath = "$env:GITHUB_WORKSPACE\$zipName"

          Write-Host "üì¶ Creating ZIP: $zipName"
          Compress-Archive -Path "$api/**/bin/Release/*" -DestinationPath $zipPath

          if (Test-Path $zipPath) {
            Write-Host "üì§ Uploading $zipName to release $env:RELEASE_TAG"
            gh release upload $env:RELEASE_TAG $zipPath --repo $env:RELEASE_REPO --clobber
          } else {
            Write-Error "‚ùå ZIP not found for $api"
            exit 1
          }
        }
