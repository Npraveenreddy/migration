name: Build All APIs

on:
  push:
    branches:
      - main
      - master
  workflow_dispatch: # allows manual run

jobs:
  build:
    runs-on: windows-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '6.0.x'

      # Build each top-level API folder
      - name: Restore and build top-level APIs
        shell: pwsh
        run: |
          $apiFolders = @(
            "AHS.GC.Web",
            "AHS.GC.authorizationportal",
            "AHS.GC.ConfigAPI",
            "AHS.GC.SmartComm"
          )

          foreach ($folder in $apiFolders) {
            $projPath = "./$folder/PortalApi.csproj"
            if (Test-Path $projPath) {
              Write-Host "=== Building API: $folder ==="
              dotnet restore $projPath
              dotnet build $projPath --configuration Release --no-restore
            } else {
              Write-Warning "Skipping $folder — project not found at $projPath"
            }
          }

      # Build each Cloud API subfolder separately
      - name: Restore and build Cloud APIs
        shell: pwsh
        run: |
          $cloudSubFolders = Get-ChildItem -Path "./AHS.GC.Cloud" -Directory
          
          foreach ($sub in $cloudSubFolders) {
            $projPath = "./AHS.GC.Cloud/$($sub.Name)/PortalApi.csproj"
            if (Test-Path $projPath) {
              Write-Host "=== Building Cloud API: $($sub.Name) ==="
              dotnet restore $projPath
              dotnet build $projPath --configuration Release --no-restore
            } else {
              Write-Warning "Skipping $($sub.Name) — project not found at $projPath"
            }
          }
