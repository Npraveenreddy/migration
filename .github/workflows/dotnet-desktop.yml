name: Build All APIs

on:
  push:
    branches:
      - main
      - master
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '6.0.x'

      - name: Restore and build top-level APIs
        shell: pwsh
        run: |
          $topLevelProjects = @(
            "./AHS.GC.Web/PortalApi.csproj",
            "./AHS.GC.authorizationportal/PortalApi.csproj",
            "./AHS.GC.ConfigAPI/PortalApi.csproj",
            "./AHS.GC.SmartComm/PortalApi.csproj"
          )

          foreach ($projPath in $topLevelProjects) {
            if (Test-Path $projPath) {
              Write-Host "Restoring $projPath"
              dotnet restore $projPath
              Write-Host "Building $projPath"
              dotnet build $projPath --configuration Release --no-restore
            } else {
              Write-Warning "Skipping $projPath â€” file not found"
            }
          }

      - name: Restore and build Cloud sub-APIs
        shell: pwsh
        run: |
          $cloudProjects = Get-ChildItem -Path "./AHS.GC.Cloud" -Recurse -Filter *.csproj
          if (-not $cloudProjects) {
            Write-Warning "No Cloud API projects found."
          }

          foreach ($proj in $cloudProjects) {
            Write-Host "Restoring $($proj.FullName)"
            dotnet restore $proj.FullName
            Write-Host "Building $($proj.FullName)"
            dotnet build $proj.FullName --configuration Release --no-restore
          }
